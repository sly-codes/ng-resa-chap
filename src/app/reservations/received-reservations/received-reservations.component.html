<div class="reservations-container">
  <h1 class="reservations-title">
    <i class="bx bx-list-check"></i>
    <span>Réservations Reçues</span>
  </h1>

  <div class="reservations-controls">
    <div class="filter-controls-group">
      <div class="control-group">
        <label for="status-filter">Statut</label>
        <select id="status-filter" [formControl]="statusFilter">
          <option value="ALL">Tous les statuts</option>
          <option *ngFor="let status of reservationStatuses" [value]="status">
            {{ getReservationStatusText(status) }}
          </option>
        </select>
      </div>

      <div class="control-group search-control">
        <i class="bx bx-search"></i>
        <input
          type="text"
          [formControl]="searchControl"
          placeholder="Rechercher..."
          aria-label="Rechercher par ressource ou demandeur"
        />
      </div>
    </div>

    <button
      class="btn-refresh"
      (click)="onRefresh()"
      [disabled]="isLoading"
      title="Rafraîchir la liste"
      aria-label="Rafraîchir la liste"
    >
      <i
        class="bx"
        [ngClass]="{ 'bx-loader-alt bx-spin': isLoading, 'bx-refresh': !isLoading }"
      ></i>
      <span class="btn-text">Actualiser</span>
    </button>
  </div>

  <div *ngIf="isLoading" class="reservations-loader">
    <i class="bx bx-loader-alt bx-spin"></i>
    <p>Chargement des demandes de réservation...</p>
  </div>

  <div *ngIf="error" class="reservations-error">
    {{ error }}
  </div>

  <ng-container *ngIf="reservations$ | async as reservations">
    <div *ngIf="reservations.length === 0 && !isLoading && !error" class="reservations-empty">
      <i class="bx bx-check-circle"></i>
      <p>Aucune demande trouvée avec les critères actuels.</p>
    </div>

    <div *ngIf="reservations.length > 0" class="reservations-table-wrapper">
      <table class="reservations-table">
        <thead>
          <tr>
            <th scope="col">Ressource</th>
            <th scope="col">Demandeur</th>
            <th scope="col">Période Demandée</th>
            <th scope="col">Notes</th>
            <th scope="col">Statut</th>
            <th scope="col" class="text-center">Décision</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let res of reservations">
            <td>
              <div class="resource-info">
                <i [class]="'bx ' + getResourceIcon(res.resource.type)" class="resource-icon"></i>
                <div class="resource-details">
                  <span class="resource-name">{{ res.resource.name }}</span>
                  <span class="resource-type">{{ res.resource.type === 'ROOM' ? 'Salle' : 'Équipement' }}</span>
                </div>
              </div>
            </td>

            <td>
              <div class="user-info">
                <span class="user-email">{{ res.locataire.email }}</span>
                <span class="user-name">{{ res.locataire.username }}</span>
              </div>
            </td>

            <td>
              <div class="period-info">
                <span class="period-date">
                  {{ res.dateDebut | date : 'dd/MM/yyyy' }} - {{ res.dateFin | date : 'dd/MM/yyyy' }}
                </span>
                <span class="period-time">
                  {{ res.dateDebut | date : 'HH:mm' }} - {{ res.dateFin | date : 'HH:mm' }}
                </span>
              </div>
            </td>

            <td>
              <span class="notes-text">{{ res.notes || '—' }}</span>
            </td>

            <td>
              <span
                class="status-badge"
                [ngClass]="{
                  'status-pending': res.status === 'PENDING',
                  'status-approved': res.status === 'CONFIRMED',
                  'status-rejected': res.status === 'REJECTED',
                  'status-cancelled': res.status === 'CANCELED'
                }"
              >
                {{ getReservationStatusText(res.status) }}
              </span>
            </td>

            <td class="text-center">
              <div *ngIf="res.status === 'PENDING'" class="reservation-actions">
                <button
                  (click)="onApprove(res.id)"
                  class="btn-approve"
                  [disabled]="res.isProcessing"
                  title="Accepter la réservation"
                  aria-label="Accepter la réservation"
                >
                  <i
                    class="bx"
                    [ngClass]="res.isProcessing ? 'bx-loader-alt bx-spin' : 'bx-check'"
                  ></i>
                  <span>Accepter</span>
                </button>
                <button
                  (click)="onReject(res.id)"
                  class="btn-reject"
                  [disabled]="res.isProcessing"
                  title="Refuser la réservation"
                  aria-label="Refuser la réservation"
                >
                  <i class="bx" [ngClass]="res.isProcessing ? 'bx-loader-alt bx-spin' : 'bx-x'"></i>
                  <span>Refuser</span>
                </button>
              </div>
              <div *ngIf="res.status !== 'PENDING'" class="reservation-status-final">
                <span class="text-muted">—</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <app-pagination
      [totalItems]="totalItems"
      [currentPage]="currentPage"
      [totalPages]="totalPages"
      (pageChange)="onPageChange($event)"
      *ngIf="reservations.length > 0 && totalPages > 1"
    ></app-pagination>
  </ng-container>
</div>