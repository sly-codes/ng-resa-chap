<div class="reservations-container">
  <!-- Header compact -->
  <div class="reservations-header">
    <div class="header-title">
      <h1 class="reservations-title">
        <i class="bx bx-book-bookmark"></i>
        <span class="title-text">Mes Réservations</span>
      </h1>
    </div>
  </div>

  <!-- Controls optimisés -->
  <div class="reservations-controls">
    <!-- Ligne 1: Recherche principale -->
    <div class="search-row">
      <div class="control-group search-control">
        <i class="bx bx-search"></i>
        <input
          type="text"
          [formControl]="searchControl"
          placeholder="Rechercher..."
          aria-label="Rechercher par ressource ou locateur"
        />
      </div>

      <button
        class="btn-refresh"
        (click)="onRefresh()"
        [disabled]="isLoading"
        title="Rafraîchir la liste"
        aria-label="Rafraîchir la liste"
      >
        <i
          class="bx"
          [ngClass]="{ 'bx-loader-alt bx-spin': isLoading, 'bx-refresh': !isLoading }"
        ></i>
        <span class="btn-text">Actualiser</span>
      </button>
    </div>

    <!-- Ligne 2: Filtres -->
    <div class="filters-row">
      <div class="control-group status-filter">
        <select id="status-filter" [formControl]="statusFilter">
          <option value="ALL">Tous statuts</option>
          <option *ngFor="let status of reservationStatuses" [value]="status">
            {{ getReservationStatusText(status) }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="reservations-loader">
    <i class="bx bx-loader-alt bx-spin"></i>
    <p>Chargement de vos réservations...</p>
  </div>

  <ng-container *ngIf="!isLoading">
    <div *ngIf="error" class="reservations-error">
      {{ error }}
    </div>

    <ng-container *ngIf="reservations$ | async as reservations">
      <div *ngIf="reservations.length === 0 && !error" class="reservations-empty">
        <i class="bx bx-calendar-minus"></i>
        <p>Aucune réservation trouvée avec les critères actuels.</p>
      </div>

      <div *ngIf="reservations.length > 0" class="reservations-table-wrapper">
        <table class="reservations-table">
          <thead>
            <tr>
              <th scope="col">Ressource Réservée</th>
              <th scope="col">Période</th>
              <th scope="col">Notes</th>
              <th scope="col">Statut</th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let res of reservations">
              <td>
                <div class="resource-info-row">
                  <i [class]="'bx ' + getResourceIcon(res.resource.type)" class="resource-icon"></i>
                  <div class="resource-details">
                    <span class="resource-name">{{ res.resource.name }}</span>
                    <span class="resource-owner">Locateur: {{ res.resource.owner.email }}</span>
                  </div>
                </div>
              </td>

              <td>
                <div class="period-info">
                  <span class="period-date">
                    {{ res.dateDebut | date : 'dd/MM/yyyy' }} -
                    {{ res.dateFin | date : 'dd/MM/yyyy' }}
                  </span>
                  <span class="period-time">
                    {{ res.dateDebut | date : 'HH:mm' }} -
                    {{ res.dateFin | date : 'HH:mm' }}
                  </span>
                </div>
              </td>

              <td>
                <button
                  placement="bottom"
                  type="button"
                  tabindex="0"
                  class="btn-desc"
                  data-bs-trigger="focus"
                  [ngbPopover]="res.notes || 'Aucune notes'"
                  popoverTitle="Description"
                >
                  Voir notes
                </button>
              </td>

              <td>
                <span
                  class="status-badge"
                  [ngClass]="{
                    'status-pending': res.status === 'PENDING',
                    'status-approved': res.status === 'CONFIRMED',
                    'status-rejected': res.status === 'REJECTED',
                    'status-cancelled': res.status === 'CANCELED'
                  }"
                >
                  {{ getReservationStatusText(res.status) }}
                </span>
              </td>

              <td class="actions-cell">
                <div
                  ngbDropdown
                  container="body"
                  placement="bottom-end"
                  class="reservation-actions-dropdown"
                >
                  <button
                    type="button"
                    class="btn-actions"
                    ngbDropdownToggle
                    [disabled]="res.isCancelling"
                    [attr.aria-label]="'Actions pour la réservation de ' + res.resource.name"
                  >
                    <i
                      class="bx"
                      [ngClass]="{
                        'bx-loader-alt bx-spin': res.isCancelling,
                        'bx-dots-vertical-rounded': !res.isCancelling
                      }"
                    ></i>
                  </button>
                  <div ngbDropdownMenu class="actions-menu">
                    <button
                      ngbDropdownItem
                      (click)="onViewReservation(res)"
                      class="action-item action-view"
                    >
                      <i class="bx bx-show"></i>
                      <span>Voir Détails</span>
                    </button>
                    <button
                      *ngIf="res.status === 'PENDING'"
                      ngbDropdownItem
                      (click)="onCancelReservation(res.id)"
                      class="action-item action-cancel"
                    >
                      <i class="bx bx-x"></i>
                      <span>Annuler</span>
                    </button>
                    <button
                      *ngIf="res.status !== 'PENDING'"
                      ngbDropdownItem
                      disabled
                      class="action-item action-disabled"
                    >
                      <i class="bx bx-info-circle"></i>
                      <span>{{ getReservationStatusText(res.status) }}</span>
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <app-pagination
        [totalItems]="totalItems"
        [currentPage]="currentPage"
        [totalPages]="totalPages"
        [isLoading]="isLoading"
        (pageChange)="onPageChange($event)"
        *ngIf="reservations.length > 0 && totalPages > 1"
      ></app-pagination>
    </ng-container>
  </ng-container>
</div>
